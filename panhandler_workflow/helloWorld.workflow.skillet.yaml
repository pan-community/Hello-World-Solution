# Hello World solution workflow

name: hello_world_workflow_panos10
label: Hello World options selection and workflow
description: |
  this workflow steps through the Hello World solution elements

type: workflow

labels:
    collection:
      - Hello World

variables:

  - name: helloWorld_options_deploy
    description: select Hello World deployment options
    default: []
    type_hint: checkbox
    cbx_list:
      - key: deploy topology in Azure
        value: deploy_in_azure
      - key: baseline deployed devices
        value: deploy_baseline

  - name: helloWorld_options_configure
    description: select Hello World configuration options
    default: []
    type_hint: checkbox
    cbx_list:
      - key: load empty baseline configuration
        value: load_baseline_config
      - key: configure NGFW
        value: configure_NGFW

  - name: helloWorld_options_assess
    description: select Hello World assessment options
    default: []
    type_hint: checkbox
    cbx_list:
      - key: run assessment report
        value: run_assessment


snippets:
# workflow stages for the Hello World Solution

# login to Azure
  - name: deployment_tools_azure_login
    when: "'deploy_in_azure' in helloWorld_options_deploy"

# select Azure subscription
  - name: azure_select_subscription
    when: "'deploy_in_azure' in helloWorld_options_deploy"

# deploy the topology in Azure
  - name: deploy_topology_1ngfw_2hosts_azure_test
    when: "'deploy_in_azure' in helloWorld_options_deploy"

# baseline the topology
  - name: panos_ansible_upgrade_downgrade
    when: "'deploy_baseline' in helloWorld_options_deploy"
    # variable names used in the ansible upgrade playbook mapped to Azure values
    transform:
      - name: ip_address
        source: ngfw_ip_address["ip_address"]
      - name: username
        source: admin_username
      - name: password
        source: admin_password

  - name: import_empty_config_ab8f807b-6c2d-4e0a-b302-88d225072b58
    when: "'load_baseline_config' in helloWorld_options_configure"
    transform:
      - name: TARGET_IP
        source: ngfw_ip_address["ip_address"]
      - name: TARGET_USERNAME
        source: admin_username
      - name: TARGET_PASSWORD
        source: admin_password

# configure the NGFW
  - name: panos_layer3_config_group_v10
    when: "'configure_NGFW' in helloWorld_options_configure"
    # variable names used in panos skillets and panHandler env mapped to Azure values
    transform:
      - name: TARGET_IP
        source: ngfw_ip_address["ip_address"]
      - name: TARGET_USERNAME
        source: admin_username
      - name: TARGET_PASSWORD
        source: admin_password
      - name: internet_intf_ipaddr
        source: fw_untrust_ip ~ "/" ~ untrust_subnet_cidr.split('/')[1]
      - name: internal_intf_ipaddr
        source: fw_trust_ip ~ "/" ~ trust_subnet_cidr.split('/')[1]
      - name: dmz_intf_ipaddr
        source: fw_dmz_ip ~ "/" ~ dmz_subnet_cidr.split('/')[1]
      - name: dataplane_default_gateway
        source: fw_untrust_ip.split(".")[0:3] | join('.') ~ ".1"

# run NGFW assessment
  - name: quick_validate_hello_world_solution
    when: "'run_assessment' in helloWorld_options_assess"
    transform:
      - name: TARGET_IP
        source: ngfw_ip_address["ip_address"]
      - name: TARGET_USERNAME
        source: admin_username
      - name: TARGET_PASSWORD
        source: admin_password